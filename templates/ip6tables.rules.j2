*filter
{% if iptables.iptables_chain -%}
{% for chain in iptables.iptables_chain -%}
:{{ chain.name }} {{ chain.policy }}
{% endfor -%}
{% endif -%}

-A INPUT -i lo -j ACCEPT
-A INPUT -d ::1/128 ! -i lo -j REJECT --reject-with icmp6-port-unreachable
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT


{% if 'ssh_port' in iptables -%}
# Allows SSH connections
# The --dport number is the same as in /etc/ssh/sshd_config
-A INPUT -p tcp -m state --state NEW --dport {{ iptables.ssh_port }} -j ACCEPT
{% endif %}


{% if iptables.iptables_chain -%}
	{% for chain in iptables.iptables_chain -%}

		{% if 'pipes' in chain -%}
{% for pipe in chain.pipes -%}
-A {{ pipe.chain }} -p {{ pipe.proto }} -m {{ pipe.proto }} -s {{ pipe.source }} -j {{ chain.name }}
{% endfor -%}
		{% endif -%}

		{% if 'rules' in chain -%}
			{% if 'tcp_dport_accept' in chain.rules -%}
{% for port in chain.rules.tcp_dport_accept -%}
-A {{ chain.name }} -p tcp -m tcp --dport {{ port }} -j ACCEPT
{% endfor -%}
			{% endif -%}

			{% if 'udp_dport_accept' in chain.rules -%}
{% for port in chain.rules.udp_dport_accept -%}
-A {{ chain.name }} -p udp -m udp --dport {{ port }} -j ACCEPT
{% endfor -%}
			{% endif -%}

			{% if 'udp_sport_dport_accept' in chain.rules -%}
{% for port in chain.rules.udp_sport_dport_accept -%}
-A {{ chain.name }} -p udp --sport {{ port.sport }} --dport {{ port.dport }} -j ACCEPT
{% endfor -%}
			{% endif -%}
		{% endif -%}

		{% if 'pipes_to' in chain -%}
{% for pipe in chain.pipes_to -%}
-A {{ chain.name }} -p {{ pipe.proto }} -m {{ pipe.proto }} -s {{ pipe.source }} -j {{ pipe.chain }}
{% endfor -%}

		{% if 'jump' in chain -%}
-A {{ chain.name }} -j {{ chain.jump }}
		{%- endif -%}

	{% endfor -%}
{%- endif %}
-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 443 -j ACCEPT
-A INPUT -p udp -m udp --sport 5353 --dport 5353 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 25 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 587 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 143 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 993 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 55445 -j ACCEPT

-A INPUT -p ipv6-icmp -j ACCEPT
-A INPUT -m limit --limit 5/min -j LOG --log-prefix "ip6tables denied: " --log-level 7
-A INPUT -j REJECT --reject-with icmp6-port-unreachable
-A FORWARD -j REJECT --reject-with icmp6-port-unreachable
-A OUTPUT -j ACCEPT
COMMIT
